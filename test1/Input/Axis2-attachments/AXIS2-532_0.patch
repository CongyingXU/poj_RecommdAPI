Index: maven.xml
===================================================================
--- maven.xml	(revision 388662)
+++ maven.xml	(working copy)
@@ -343,6 +343,8 @@
             <fileset dir="modules/addressing/target/classes"/>
             <fileset dir="modules/codegen/target/classes"/>
             <fileset dir="modules/adb/target/classes"/>
+	    <fileset dir="modules/clustering/target/classes"/>
+            <fileset dir="modules/session/target/classes"/>
             <fileset dir="modules/addressing/target/">
                 <include name="modules/addressing-${addressing_version}.mar"/>
             </fileset>
@@ -391,6 +393,16 @@
             <ant:fileset file="modules/doom/target/axis2-doom-${pom.currentVersion}.jar"/>
         </ant:copy>
 
+        <!-- Copy the clustering jar -->
+        <ant:copy toDir="target/temp/war/lib">
+            <ant:fileset file="modules/clustering/target/axis2-clustering-${pom.currentVersion}.jar"/>
+        </ant:copy>
+
+	<!-- Copy the session jar -->
+        <ant:copy toDir="target/temp/war/lib">
+            <ant:fileset file="modules/session/target/axis2-session-${pom.currentVersion}.jar"/>
+        </ant:copy>
+	
         <!-- Copy the codegen jar -->
         <ant:copy toDir="target/temp/war/lib">
             <ant:fileset file="modules/codegen/target/axis2-codegen-${pom.currentVersion}.jar"/>
@@ -613,7 +625,13 @@
         <ant:copy toDir="${std.bin.temp.dir}/lib">
             <ant:fileset file="modules/adb/target/axis2-adb-${pom.currentVersion}.jar"/>
             <ant:fileset file="modules/codegen/target/axis2-codegen-${pom.currentVersion}.jar"/>
-            <ant:fileset file="modules/doom/target/axis2-doom-${pom.currentVersion}.jar"/>
+	    <ant:fileset file="modules/doom/target/axis2-doom-${pom.currentVersion}.jar"/>
+      
+            <!-- Copy the clustering jar -->
+	    <ant:fileset file="modules/clustering/target/axis2-clustering-${pom.currentVersion}.jar"/>
+           
+            <!-- Copy the session jar -->
+            <ant:fileset file="modules/session/target/axis2-session-${pom.currentVersion}.jar"/>
         </ant:copy>
 
         <!-- Copy addressing mar -->
@@ -666,7 +684,9 @@
                 <ant:include name="**/modules/codegen/**"/>
                 <ant:include name="**/modules/webapp/**"/>
                 <ant:include name="**/modules/doom/**"/>
-                <ant:include name="**/modules/addressing/**"/>
+		<ant:include name="**/modules/addressing/**"/>
+		<ant:include name="**/modules/clustering/**"/>
+		<ant:include name="**/modules/session/**"/>
                 <ant:include name="**/modules/samples/**"/>
                 <ant:exclude name="**/SameServiceAddingTest.java"/>
                 <!-- TODO: This is failing in the distros. Must Fix it. -->
@@ -790,7 +810,9 @@
                 <ant:pathelement location="modules/codegen/src"/>
                 <ant:pathelement location="modules/common/src"/>
                 <ant:pathelement location="modules/core/src"/>
-                <ant:pathelement location="modules/doom/src"/>
+		<ant:pathelement location="modules/doom/src"/>
+		<ant:pathelement location="modules/clustering/src"/>
+                <ant:pathelement location="modules/session/src"/>
                 <ant:pathelement location="modules/jaxws/src"/>
                 <ant:pathelement location="modules/saaj/src"/>
                 <ant:pathelement location="modules/security/src"/>
@@ -881,7 +903,9 @@
             <ant:fileset file="modules/adb/target/axis2-adb-${pom.currentVersion}.jar"/>
             <ant:fileset file="modules/doom/target/axis2-doom-${pom.currentVersion}.jar"/>
             <ant:fileset file="modules/codegen/target/axis2-codegen-${pom.currentVersion}.jar"/>
-        </ant:copy>
+            <ant:fileset file="modules/clustering/target/axis2-clustering-${pom.currentVersion}.jar"/>
+	    <ant:fileset file="modules/session/target/axis2-session-${pom.currentVersion}.jar"/>
+    </ant:copy>
     </goal>
 
     <define:taglib uri="macros">
Index: modules/samples/maven.xml
===================================================================
--- modules/samples/maven.xml	(revision 389620)
+++ modules/samples/maven.xml	(working copy)
@@ -40,6 +40,8 @@
         <attainGoal name="mtomSample"/>
         <attainGoal name="groovy"/>
         <attainGoal name="securitySample"/>
+	<attainGoal name="sessionEchoSample"/>
+	<attainGoal name="sessionATMSample"/>
       <attainGoal name="sgccalculator"/>
     </goal>
 
@@ -348,6 +350,55 @@
             file="script/SGCCalculator/run.sh"/>
     </goal>
 
+    <!-- ================================================================ -->
+    <!--- Session ATM  Sample  -->
+    <!-- ================================================================ -->
+
+    <goal name="sessionATMSample">
+        <mkdir dir="${samples.dir}/sessionATM"/>
+        <mkdir dir="${samples.dir}/sessionATM/src"/>
+        <ant:copy todir="${samples.dir}/sessionATM/src">
+            <ant:fileset dir="src">
+                <ant:include name="sample/session/atm/**"/>
+            </ant:fileset>
+        </ant:copy>
+
+        <jar destfile="${samples.dir}/session/SessionATMService.aar">
+            <fileset dir="src/sample/session/atm">
+                <include name="META-INF/**"/>
+            </fileset>
+            <fileset dir="target/classes">
+                <include name="sample/session/atm/**/*.class"/>
+            </fileset>
+        </jar>
+
+    </goal>
+
+    <!-- ================================================================ -->
+    <!--- Session Echo Sample  -->
+    <!-- ================================================================ -->
+
+    <goal name="sessionEchoSample">
+        <mkdir dir="${samples.dir}/sessionEcho"/>
+        <mkdir dir="${samples.dir}/sessionEcho/src"/>
+        <ant:copy todir="${samples.dir}/sessionEcho/src">
+            <ant:fileset dir="src">
+                <ant:include name="sample/session/echo/**"/>
+            </ant:fileset>
+        </ant:copy>
+
+        <jar destfile="${samples.dir}/session/SessionEchoService.aar">
+            <fileset dir="src/sample/session/echo">
+                <include name="META-INF/**"/>
+            </fileset>
+            <fileset dir="target/classes">
+                <include name="sample/session/echo/**/*.class"/>
+            </fileset>
+        </jar>
+
+    </goal>
+
+
     <preGoal name="itest:compile">
         <u:file var="file" name="${maven.itest.src}"/>
         <j:if test="${!file.exists()}">
Index: modules/core/conf/axis2.xml
===================================================================
--- modules/core/conf/axis2.xml	(revision 388662)
+++ modules/core/conf/axis2.xml	(working copy)
@@ -102,10 +102,10 @@
     <!-- Comment this to disable Addressing -->
     <module ref="addressing"/>
 
-    <!--Configuring module , providing parameters for modules whether they refer or not-->
-    <!--<moduleConfig name="addressing">-->
-    <!--<parameter name="addressingPara" locked="false">N/A</parameter>-->
-    <!--</moduleConfig>-->
+    <!-- -Configuring module , providing parameters for modules whether they refer or not-->
+    <moduleConfig name="addressing">
+      <parameter name="addressingPara" locked="false">N/A</parameter>
+    </moduleConfig>
 
     <!-- ================================================= -->
     <!-- Phases  -->
@@ -113,7 +113,12 @@
     <phaseOrder type="inflow">
         <!--  System pre defined phases       -->
         <phase name="TransportIn"/>
-        <phase name="PreDispatch"/>
+        <phase name="PreDispatch">
+	    <handler name="SessionHandler"
+                     class="org.apache.axis2.session.SessionHandler">
+                <order phase="PreDispatch" phaseLast="true"/>
+            </handler>
+	</phase>
         <phase name="Dispatch" class="org.apache.axis2.engine.DispatchPhase">
             <handler name="RequestURIBasedDispatcher"
                      class="org.apache.axis2.engine.RequestURIBasedDispatcher">
@@ -149,7 +154,12 @@
         <!--system predefined phase-->
         <!--these phase will run irrespective of the service-->
         <phase name="PolicyDetermination"/>
-        <phase name="MessageOut"/>
+        <phase name="MessageOut">
+            <handler name="EndOfRequestHandler"
+                     class="org.apache.axis2.session.EndOfRequestHandler">
+                <order phase="MessageOut" phaseFirst="true"/>
+            </handler>
+	</phase>
     </phaseOrder>
     <phaseOrder type="INfaultflow">
         <!--      user can add his own phases to this area  -->
@@ -161,5 +171,39 @@
         <phase name="PolicyDetermination"/>
         <phase name="MessageOut"/>
     </phaseOrder>
+
+    <!-- ================================================= -->
+    <!-- Session Management and Clustering  -->
+    <!-- Comment this section on client side, no session management is needed for client side -->
+    <!-- ================================================= -->
+    <sessionManagerFactory class="org.apache.axis2.session.DefaultSessionManagerFactory">
+	<sessionManager class="org.apache.axis2.session.Axis2SessionManager">
+	   <maxNoOfActiveSessions>50</maxNoOfActiveSessions>
+	   <!-- in seconds, defaults to 5 mins -->
+	   <maxInactiveTime>300</maxInactiveTime>
+           <checkInterval>300</checkInterval>
+           <sessionIdFactory class="org.apache.axis2.session.DefaultSessionIdFactory"/>
+           <!--
+              The following options are available for Session Management
+              1.) Use TransientSessionManager if u only need in memory session management
+
+	      2.) Use PersistantSessionManager if u need to persist sessions localy, sessions
+                  will survive a restart (Not supported yet)
+	
+              3.) Use WADISessionManager if u need to cluster your sessions
+
+              4.) Use your own MySessionManager for your custom needs
+            -->
+
+	   <delegate class="org.apache.axis2.session.persistance.TransientSessionManager"/>
+
+	   <!-- (not supported yet)
+	   <delegate class="org.apache.axis2.session.persistance.PersistantSessionManager"/>
+           -->
+	   <!-- (not supported yet)
+	   <delegate class="org.apache.axis2.clustering.wadi.WADISessionManager"/>
+           -->
+       </sessionManager>
+    </sessionManagerFactory> 
 </axisconfig>
 
Index: modules/core/src/org/apache/axis2/deployment/AxisConfigBuilder.java
===================================================================
--- modules/core/src/org/apache/axis2/deployment/AxisConfigBuilder.java	(revision 388662)
+++ modules/core/src/org/apache/axis2/deployment/AxisConfigBuilder.java	(working copy)
@@ -17,6 +17,14 @@
 
 package org.apache.axis2.deployment;
 
+import java.io.InputStream;
+import java.util.ArrayList;
+import java.util.HashMap;
+import java.util.Iterator;
+
+import javax.xml.namespace.QName;
+import javax.xml.stream.XMLStreamException;
+
 import org.apache.axiom.om.OMAttribute;
 import org.apache.axiom.om.OMElement;
 import org.apache.axis2.AxisFault;
@@ -37,19 +45,12 @@
 import org.apache.axis2.transport.TransportListener;
 import org.apache.axis2.transport.TransportSender;
 
-import javax.xml.namespace.QName;
-import javax.xml.stream.XMLStreamException;
-import java.io.InputStream;
-import java.util.ArrayList;
-import java.util.HashMap;
-import java.util.Iterator;
-
 public class AxisConfigBuilder extends DescriptionBuilder {
 
     private DeploymentEngine engine;
 
     public AxisConfigBuilder(InputStream serviceInputStream, DeploymentEngine engine,
-                             AxisConfiguration axisConfiguration) {
+                             AxisConfiguration axisConfiguration) {    	
         super(serviceInputStream, axisConfiguration);
         this.engine = engine;
     }
@@ -126,13 +127,21 @@
             if (defaultModuleVerionElement != null) {
                 processDefaultModuleVersions(defaultModuleVerionElement);
             }
-
+            
+            // processing session management and clustering elements
+            OMElement sessionManagerFactoryElement = config_element.getFirstChildWithName(new QName(TAG_SESSION_MANAGER_FACTORY));
+            if(sessionManagerFactoryElement != null){
+	            System.out.println("Element : " + sessionManagerFactoryElement);
+	            SessionManagementBuilder sessionMgtBuilder = new SessionManagementBuilder(sessionManagerFactoryElement);	
+	            axisConfig.setSessionManager(sessionMgtBuilder.buildSessionManager());
+            }	
+            
         } catch (XMLStreamException e) {
             throw new DeploymentException(e);
         }
     }
 
-    protected void processModuleConfig(Iterator moduleConfigs, ParameterInclude parent,
+	protected void processModuleConfig(Iterator moduleConfigs, ParameterInclude parent,
                                        AxisConfiguration config)
             throws DeploymentException {
         while (moduleConfigs.hasNext()) {
@@ -442,5 +451,6 @@
         }
         Class phaseClass = axisConfig.getSystemClassLoader().loadClass(className);
         return (Phase) phaseClass.newInstance();
-    }
+    }  
+
 }
Index: modules/core/src/org/apache/axis2/deployment/DeploymentConstants.java
===================================================================
--- modules/core/src/org/apache/axis2/deployment/DeploymentConstants.java	(revision 388662)
+++ modules/core/src/org/apache/axis2/deployment/DeploymentConstants.java	(working copy)
@@ -58,8 +58,14 @@
     String TAG_TRANSPORT = "transport";
     String TAG_MEP = "mep";
     String TAG_DEFAULT_MODULE_VERSION = "defaultModuleVersions";
-
-
+    String TAG_SESSION_MANAGER_FACTORY = "sessionManagerFactory";
+    String TAG_SESSION_MANAGER = "sessionManager";
+    String TAG_SESSION_ID_FACTORY = "sessionIdFactory";
+    String TAG_SESSION_MANAGER_DELEGATE = "delegate";
+    String TAG_MAX_ACTIVE_SESSIONS = "maxNoOfActiveSessions";
+    String TAG_MAX_INACTIVE_TIME = "maxInactiveTime";    
+    String TAG_CHECK_INTERVAL = "checkInterval";
+    
     String TAG_FLOW_OUT_FAULT = "Outfaultflow";    // faultflow start tag
     String TAG_FLOW_OUT = "outflow";         // outflow start tag
     String TAG_FLOW_IN_FAULT = "INfaultflow";    // faultflow start tag
Index: modules/core/src/org/apache/axis2/context/MessageContext.java
===================================================================
--- modules/core/src/org/apache/axis2/context/MessageContext.java	(revision 388662)
+++ modules/core/src/org/apache/axis2/context/MessageContext.java	(working copy)
@@ -33,7 +33,7 @@
 import org.apache.axis2.description.TransportInDescription;
 import org.apache.axis2.description.TransportOutDescription;
 import org.apache.axis2.engine.AxisConfiguration;
-
+import org.apache.axis2.session.Session;
 import javax.xml.namespace.QName;
 import java.util.ArrayList;
 
@@ -191,6 +191,8 @@
     //The value will be set by the tarnsport receiver and there will be validation for the transport
     //at the dispatch phase (its post condition)
     private String incomingTransportName;
+    
+    private Session session;
 
     public MessageContext() {
         super(null);
@@ -894,4 +896,12 @@
     public void setIncomingTransportName(String incomingTransportName) {
         this.incomingTransportName = incomingTransportName;
     }
+
+	public Session getSession() {
+		return session;
+	}
+
+	public void setSession(Session session) {
+		this.session = session;
+	}
 }
Index: modules/core/src/org/apache/axis2/receivers/RawXMLINOutMessageReceiver.java
===================================================================
--- modules/core/src/org/apache/axis2/receivers/RawXMLINOutMessageReceiver.java	(revision 388662)
+++ modules/core/src/org/apache/axis2/receivers/RawXMLINOutMessageReceiver.java	(working copy)
@@ -111,6 +111,10 @@
                 }
 
                 newmsgContext.setEnvelope(envelope);
+                
+                // pass in the session from the in msgContext to the out msgContext
+                newmsgContext.setSession(msgContext.getSession());
+                
             } else {
                 throw new AxisFault(Messages.getMessage("methodNotImplemented",
                         opDesc.getName().toString()));
Index: modules/core/src/org/apache/axis2/engine/AxisConfiguration.java
===================================================================
--- modules/core/src/org/apache/axis2/engine/AxisConfiguration.java	(revision 388662)
+++ modules/core/src/org/apache/axis2/engine/AxisConfiguration.java	(working copy)
@@ -31,6 +31,8 @@
 import org.apache.axis2.description.TransportOutDescription;
 import org.apache.axis2.i18n.Messages;
 import org.apache.axis2.phaseresolver.PhaseResolver;
+import org.apache.axis2.session.NullSessionManager;
+import org.apache.axis2.session.SessionManager;
 import org.apache.axis2.util.Utils;
 import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
@@ -90,6 +92,8 @@
     protected PhasesInfo phasesinfo;
     private ClassLoader serviceClassLoader;
     private ClassLoader systemClassLoader;
+    
+    private SessionManager defaultSessionManager;
 
     /**
      * Constructor AxisConfigurationImpl.
@@ -109,6 +113,7 @@
         serviceClassLoader = Thread.currentThread().getContextClassLoader();
         moduleClassLoader = Thread.currentThread().getContextClassLoader();
         this.phasesinfo = new PhasesInfo();
+        defaultSessionManager = new NullSessionManager();
     }
 
     public void addMessageReceiver(String mepURL, MessageReceiver messageReceiver) {
@@ -312,6 +317,7 @@
         }
     }
 
+    
     public void notifyObservers(int event_type, AxisService service) {
         AxisEvent event = new AxisEvent(event_type);
 
@@ -530,6 +536,10 @@
     public HashMap getTransportsOut() {
         return transportsOut;
     }
+    
+	public SessionManager getSessionManager() {
+		return defaultSessionManager;
+	}
 
     public boolean isEngaged(QName moduleName) {
         boolean b = engagedModules.contains(moduleName);
@@ -579,6 +589,11 @@
         this.systemClassLoader = classLoader;
     }
 
+
+	public void setSessionManager(SessionManager defaultSessionManager) {
+		this.defaultSessionManager = defaultSessionManager;
+	}
+	
     public static String getAxis2HomeDirectory() {
         // if user has set the axis2 home variable try to get that from System properties
         String axis2home = System.getProperty(Constants.AXIS2_HOME);
@@ -641,4 +656,5 @@
         service.setActive(true);
         notifyObservers(AxisEvent.SERVICE_START, service);
     }
+
 }
Index: etc/project.properties
===================================================================
--- etc/project.properties	(revision 388662)
+++ etc/project.properties	(working copy)
@@ -58,6 +58,8 @@
 modules/integration/project.xml,\
 modules/saaj/project.xml,\
 modules/doom/project.xml,\
+modules/session/project.xml,\
+modules/clustering/project.xml,\
 ${optional.includes}
 
 #maven.multiproject.excludes=modules/tool/project.xml
Index: build.xml
===================================================================
--- build.xml	(revision 388662)
+++ build.xml	(working copy)
@@ -227,6 +227,8 @@
       <include name="wsdl/src/**/*.java"/>
       <include name="xml/src/**/*.java"/>
       <include name="doom/src/**/*.java"/>
+      <include name="session/src/**/*.java"/>
+      <include name="clustering/src/**/*.java"/>
     </javac>
     <copy todir="${basedir}/target/classes/">
       <fileset dir="${basedir}/modules/common/src">
