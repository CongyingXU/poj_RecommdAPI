From 969b8efbca480ab9eff7728b88ec1cc2224c9f3e Mon Sep 17 00:00:00 2001
From: chenheng <chenheng@fenbi.com>
Date: Tue, 11 Aug 2015 22:38:26 +0800
Subject: [PATCH] HBASE-14203 remove duplicate code getTableDescriptor in
 HTable

---
 .../hbase/client/ConnectionImplementation.java     |   12 ++++++++++-
 .../org/apache/hadoop/hbase/client/HTable.java     |   22 ++-----------------
 2 files changed, 14 insertions(+), 20 deletions(-)

diff --git a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/ConnectionImplementation.java b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/ConnectionImplementation.java
index 2754997..2a9aefd 100644
--- a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/ConnectionImplementation.java
+++ b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/ConnectionImplementation.java
@@ -173,6 +173,8 @@ class ConnectionImplementation implements ClusterConnection, Closeable {
 
   private final ClientBackoffPolicy backoffPolicy;
 
+  private Admin admin;
+
   /**
    * constructor
    * @param conf Configuration object
@@ -359,7 +361,15 @@ class ConnectionImplementation implements ClusterConnection, Closeable {
 
   @Override
   public Admin getAdmin() throws IOException {
-    return new HBaseAdmin(this);
+    if (admin != null) {
+      return admin;
+    }
+    synchronized (admin) {
+      if (admin == null) {
+        admin = new HBaseAdmin(this);
+      }
+      return admin;
+    }
   }
 
   private ExecutorService getBatchPool() {
diff --git a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/HTable.java b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/HTable.java
index 89c7893..84a55bc 100644
--- a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/HTable.java
+++ b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/HTable.java
@@ -265,30 +265,14 @@ public class HTable implements HTableInterface {
    */
   @Override
   public HTableDescriptor getTableDescriptor() throws IOException {
-    // TODO: This is the same as HBaseAdmin.getTableDescriptor(). Only keep one.
-    if (tableName == null) return null;
-    if (tableName.equals(TableName.META_TABLE_NAME)) {
+    if (tableName != null && tableName.equals(TableName.META_TABLE_NAME)) {
       return HTableDescriptor.META_TABLEDESC;
     }
-    HTableDescriptor htd = executeMasterCallable(
-      new MasterCallable<HTableDescriptor>(getConnection()) {
-      @Override
-      public HTableDescriptor call(int callTimeout) throws ServiceException {
-        GetTableDescriptorsResponse htds;
-        GetTableDescriptorsRequest req =
-            RequestConverter.buildGetTableDescriptorsRequest(tableName);
-        htds = master.getTableDescriptors(null, req);
-
-        if (!htds.getTableSchemaList().isEmpty()) {
-          return HTableDescriptor.convert(htds.getTableSchemaList().get(0));
-        }
-        return null;
-      }
-    });
+    HTableDescriptor htd = this.connection.getAdmin().getTableDescriptor(tableName);
     if (htd != null) {
       return new UnmodifyableHTableDescriptor(htd);
     }
-    throw new TableNotFoundException(tableName.getNameAsString());
+    return null;
   }
 
   private <V> V executeMasterCallable(MasterCallable<V> callable) throws IOException {
-- 
1.7.9

