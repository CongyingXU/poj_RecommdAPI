From 921efda6ab5b64b2b7fdf8004090489b5fb6f77b Mon Sep 17 00:00:00 2001
From: Clara <claraxiong@flurry.com>
Date: Tue, 1 Mar 2016 14:27:20 -0800
Subject: [PATCH] HBASE-15181 Addendum to solve findbugs and some minor cleanup

---
 .../regionserver/compactions/DateTieredCompactionPolicy.java     | 9 ++++++++-
 .../apache/hadoop/hbase/regionserver/TestCompactionPolicy.java   | 4 ++--
 2 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/DateTieredCompactionPolicy.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/DateTieredCompactionPolicy.java
index 16b534c..9f65e6e 100644
--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/DateTieredCompactionPolicy.java
+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/DateTieredCompactionPolicy.java
@@ -135,6 +135,13 @@ public class DateTieredCompactionPolicy extends RatioBasedCompactionPolicy {
         partitionFilesToBuckets(candidatesInWindow, comConf.getBaseWindowMillis(),
           comConf.getWindowsPerTier(), now);
     LOG.debug("Compaction buckets are: " + buckets);
+    if (buckets.size() >= storeConfigInfo.getBlockingFileCount()) {
+      LOG.warn("Number of compaction buckets:" +  buckets.size()
+        + ", exceeds blocking file count setting: "
+        + storeConfigInfo.getBlockingFileCount()
+        + ", either increase hbase.hstore.blockingStoreFiles or "
+        + "reduce the number of tiered compaction windows");
+    }
 
     return newestBucket(buckets, comConf.getIncomingWindowMin(), now,
       comConf.getBaseWindowMillis(), mayUseOffPeak);
@@ -234,7 +241,7 @@ public class DateTieredCompactionPolicy extends RatioBasedCompactionPolicy {
       public boolean apply(StoreFile storeFile) {
         // Known findbugs issue to guava. SuppressWarning or Nonnull annotation don't work.
         if (storeFile == null) {
-          throw new NullPointerException();
+          return false;
         }
         return storeFile.getMaximumTimestamp() >= cutoff;
       }
diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompactionPolicy.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompactionPolicy.java
index f5f0926..24b3667 100644
--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompactionPolicy.java
+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompactionPolicy.java
@@ -50,13 +50,13 @@ import org.junit.experimental.categories.Category;
 
 @Category(SmallTests.class)
 public class TestCompactionPolicy {
-  private final static Log LOG = LogFactory.getLog(TestDefaultCompactSelection.class);
+  private final static Log LOG = LogFactory.getLog(TestCompactionPolicy.class);
   protected final static HBaseTestingUtility TEST_UTIL = new HBaseTestingUtility();
 
   protected Configuration conf;
   protected HStore store;
   private static final String DIR = TEST_UTIL.getDataTestDir(
-    TestDefaultCompactSelection.class.getSimpleName()).toString();
+    TestCompactionPolicy.class.getSimpleName()).toString();
   protected static Path TEST_FILE;
   protected static final int minFiles = 3;
   protected static final int maxFiles = 5;
-- 
1.9.3 (Apple Git-50)

