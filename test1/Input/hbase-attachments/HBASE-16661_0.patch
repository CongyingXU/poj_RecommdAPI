From cd54598368c68cb8538a42afe0d7a8b1747eea25 Mon Sep 17 00:00:00 2001
From: Dustin Pho <pho@fb.com>
Date: Tue, 20 Sep 2016 17:26:18 -0700
Subject: [PATCH] HBASE-16661 Add last major compaction age to per-region
 metrics

---
 .../hadoop/hbase/regionserver/MetricsRegionSource.java       |  1 +
 .../hadoop/hbase/regionserver/MetricsRegionWrapper.java      |  5 +++++
 .../hadoop/hbase/regionserver/MetricsRegionSourceImpl.java   |  4 ++++
 .../hbase/regionserver/TestMetricsRegionSourceImpl.java      |  5 +++++
 .../java/org/apache/hadoop/hbase/regionserver/HRegion.java   | 12 +++++++-----
 .../hadoop/hbase/regionserver/MetricsRegionWrapperImpl.java  |  5 +++++
 .../hadoop/hbase/regionserver/MetricsRegionWrapperStub.java  |  5 +++++
 7 files changed, 32 insertions(+), 5 deletions(-)

diff --git a/hbase-hadoop-compat/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionSource.java b/hbase-hadoop-compat/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionSource.java
index 911c757..c4678c8 100644
--- a/hbase-hadoop-compat/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionSource.java
+++ b/hbase-hadoop-compat/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionSource.java
@@ -29,6 +29,7 @@ public interface MetricsRegionSource extends Comparable<MetricsRegionSource> {
   String SIZE_VALUE_NAME = "size";
   String COMPACTIONS_COMPLETED_COUNT = "compactionsCompletedCount";
   String COMPACTIONS_FAILED_COUNT = "compactionsFailedCount";
+  String LAST_MAJOR_COMPACTION_AGE = "lastMajorCompactionAge";
   String NUM_BYTES_COMPACTED_COUNT = "numBytesCompactedCount";
   String NUM_FILES_COMPACTED_COUNT = "numFilesCompactedCount";
   String COMPACTIONS_COMPLETED_DESC = "Number of compactions that have completed.";
diff --git a/hbase-hadoop-compat/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionWrapper.java b/hbase-hadoop-compat/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionWrapper.java
index e3fd5c3..cfc0742 100644
--- a/hbase-hadoop-compat/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionWrapper.java
+++ b/hbase-hadoop-compat/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionWrapper.java
@@ -106,6 +106,11 @@ public interface MetricsRegionWrapper {
   long getNumCompactionsCompleted();
 
   /**
+   *  @return Age of the last major compaction
+   */
+  long getLastMajorCompactionAge();
+
+  /**
    * Returns the total number of compactions that have been reported as failed on this region.
    * Note that a given compaction can be reported as both completed and failed if an exception
    * is thrown in the processing after {@code HRegion.compact()}.
diff --git a/hbase-hadoop2-compat/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionSourceImpl.java b/hbase-hadoop2-compat/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionSourceImpl.java
index c0d71d5..1c04400 100644
--- a/hbase-hadoop2-compat/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionSourceImpl.java
+++ b/hbase-hadoop2-compat/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionSourceImpl.java
@@ -269,6 +269,10 @@ public class MetricsRegionSourceImpl implements MetricsRegionSource {
           MetricsRegionSource.COMPACTIONS_FAILED_DESC),
           this.regionWrapper.getNumCompactionsFailed());
       mrb.addCounter(Interns.info(
+              regionNamePrefix + MetricsRegionSource.LAST_MAJOR_COMPACTION_AGE,
+              MetricsRegionSource.LAST_MAJOR_COMPACTION_AGE),
+          this.regionWrapper.getLastMajorCompactionAge());
+      mrb.addCounter(Interns.info(
               regionNamePrefix + MetricsRegionSource.NUM_BYTES_COMPACTED_COUNT,
               MetricsRegionSource.NUM_BYTES_COMPACTED_DESC),
           this.regionWrapper.getNumBytesCompacted());
diff --git a/hbase-hadoop2-compat/src/test/java/org/apache/hadoop/hbase/regionserver/TestMetricsRegionSourceImpl.java b/hbase-hadoop2-compat/src/test/java/org/apache/hadoop/hbase/regionserver/TestMetricsRegionSourceImpl.java
index cb97570..6724939 100644
--- a/hbase-hadoop2-compat/src/test/java/org/apache/hadoop/hbase/regionserver/TestMetricsRegionSourceImpl.java
+++ b/hbase-hadoop2-compat/src/test/java/org/apache/hadoop/hbase/regionserver/TestMetricsRegionSourceImpl.java
@@ -147,6 +147,11 @@ public class TestMetricsRegionSourceImpl {
     }
 
     @Override
+    public long getLastMajorCompactionAge() {
+      return 0;
+    }
+
+    @Override
     public long getNumCompactionsCompleted() {
       return 0;
     }
diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java
index 351a389..87d7ccf 100644
--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java
+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java
@@ -1714,7 +1714,7 @@ public class HRegion implements HeapSize, PropagatingConfigurationObserver, Regi
   }
 
   @Override
-  public long getOldestHfileTs(boolean majorCompactioOnly) throws IOException {
+  public long getOldestHfileTs(boolean majorCompactionOnly) {
     long result = Long.MAX_VALUE;
     for (Store store : getStores()) {
       Collection<StoreFile> storeFiles = store.getStorefiles();
@@ -1724,10 +1724,12 @@ public class HRegion implements HeapSize, PropagatingConfigurationObserver, Regi
         if (sfReader == null) continue;
         HFile.Reader reader = sfReader.getHFileReader();
         if (reader == null) continue;
-        if (majorCompactioOnly) {
-          byte[] val = reader.loadFileInfo().get(StoreFile.MAJOR_COMPACTION_KEY);
-          if (val == null) continue;
-          if (val == null || !Bytes.toBoolean(val)) {
+        if (majorCompactionOnly) {
+          try {
+            byte[] val = reader.loadFileInfo().get(StoreFile.MAJOR_COMPACTION_KEY);
+            if (val == null || !Bytes.toBoolean(val)) continue;
+          } catch (IOException ioe) {
+            LOG.warn("Problem reading store file " + file + ", skipping");
             continue;
           }
         }
diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionWrapperImpl.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionWrapperImpl.java
index 01e6d06..e65f342 100644
--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionWrapperImpl.java
+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/MetricsRegionWrapperImpl.java
@@ -141,6 +141,11 @@ public class MetricsRegionWrapperImpl implements MetricsRegionWrapper, Closeable
   }
 
   @Override
+  public long getLastMajorCompactionAge() {
+    return this.region.getOldestHfileTs(true);
+  }
+
+  @Override
   public long getNumCompactionsFailed() {
     return this.region.compactionsFailed.get();
   }
diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/MetricsRegionWrapperStub.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/MetricsRegionWrapperStub.java
index 72b8b64..1a4e121 100644
--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/MetricsRegionWrapperStub.java
+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/MetricsRegionWrapperStub.java
@@ -121,6 +121,11 @@ public class MetricsRegionWrapperStub implements MetricsRegionWrapper {
   }
 
   @Override
+  public long getLastMajorCompactionAge() {
+    return 0;
+  }
+
+  @Override
   public long getNumCompactionsFailed() {
     return 0;
   }
-- 
2.8.0-rc2

