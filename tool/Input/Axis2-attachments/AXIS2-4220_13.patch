package org.apache.axis2.mtompolicy;

import java.util.List;

import org.apache.axis2.AxisFault;
import org.apache.axis2.Constants;
import org.apache.axis2.context.MessageContext;
import org.apache.axis2.engine.Handler.InvocationResponse;
import org.apache.axis2.handlers.AbstractHandler;
import org.apache.axis2.policy.model.MTOMAssertion;
import org.apache.neethi.Assertion;
import org.apache.neethi.Policy;

/**
 * 
 * @author <a href="mailto:Dobri.Kitipov@softwareag.com">Dobri Kitipov (bgdki)</a>
 */

public class MTOMInHandler extends AbstractHandler {

	public InvocationResponse invoke(MessageContext msgCtx) throws AxisFault {

		Policy policy = msgCtx.getEffectivePolicy();

		if (policy == null) {
			return InvocationResponse.CONTINUE;
		}

		// TODO When we have policy alternatives support we will have to change
		// the implementation.
		List<Assertion> list = (List<Assertion>) policy.getAlternatives()
				.next();

		for (Assertion assertion : list) {
			if (assertion instanceof MTOMAssertion) {
				assertion = (MTOMAssertion) assertion;
				Boolean mimeBinary = (Boolean) msgCtx.getProperty("mimeBinary");

				// If MTOM is mandatory then both request and response SHOULD be MTOMized.
				// That is why we both check the client and server side (we have no msgCtx.isServerSide() check).
				// As stated into the "MTOM Serialization Policy Assertion 1.1" if the client is not able to 
				// MTOMize and the MTOM is OPTIONAL then server side SHOULD respond with NON MTOMized response.
				// Nevertheless we CANNOT do that check here since if this module is available at client side
				// it guarantees that the client CAN MTOMize?! Is it possible to have Axis2 client with this module
				// engaged and msgCtx.isDoingMTOM() set to FALSE when the policy states that MTOM should be used?!
				if (!assertion.isOptional()) {// || (assertion.isOptional() &&
												// msgCtx.isDoingMTOM())
					if (mimeBinary == null || !mimeBinary.booleanValue()) {
						if (msgCtx.isServerSide()) {
						throw new AxisFault(
								"The SOAP REQUEST sent by the client IS NOT MTOMized!");
						} else {
							throw new AxisFault(
							"The SOAP RESPONSE sent by the service IS NOT MTOMized!");
						}
					}
				}
			}
		}

		return InvocationResponse.CONTINUE;

	}

}
