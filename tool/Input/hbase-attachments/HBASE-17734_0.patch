From a447bbb5962b80a671fa7837b3df9b4b1e4c5ac1 Mon Sep 17 00:00:00 2001
From: ChiaPing Tsai <chia7712@gmail.com>
Date: Sun, 5 Mar 2017 06:14:49 +0800
Subject: [PATCH] HBASE-17734 guard against possibly coping the qualifier in
 the ScanDeleteTracker

---
 .../querymatcher/ScanDeleteTracker.java            | 28 ++++++++++------------
 1 file changed, 13 insertions(+), 15 deletions(-)

diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/querymatcher/ScanDeleteTracker.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/querymatcher/ScanDeleteTracker.java
index 450a30e..5a9cf4c 100644
--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/querymatcher/ScanDeleteTracker.java
+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/querymatcher/ScanDeleteTracker.java
@@ -48,9 +48,7 @@ public class ScanDeleteTracker implements DeleteTracker {
   protected boolean hasFamilyStamp = false;
   protected long familyStamp = 0L;
   protected SortedSet<Long> familyVersionStamps = new TreeSet<Long>();
-  protected byte[] deleteBuffer = null;
-  protected int deleteOffset = 0;
-  protected int deleteLength = 0;
+  protected Cell deleteCell = null;
   protected byte deleteType = 0;
   protected long deleteTimestamp = 0L;
 
@@ -74,16 +72,14 @@ public class ScanDeleteTracker implements DeleteTracker {
         return;
       }
 
-      if (deleteBuffer != null && type < deleteType) {
+      if (deleteCell != null && type < deleteType) {
         // same column, so ignore less specific delete
-        if (CellUtil.matchingQualifier(cell, deleteBuffer, deleteOffset, deleteLength)) {
+        if (CellUtil.matchingQualifier(cell, deleteCell)) {
           return;
         }
       }
       // new column, or more general delete type
-      deleteBuffer = cell.getQualifierArray();
-      deleteOffset = cell.getQualifierOffset();
-      deleteLength = cell.getQualifierLength();
+      deleteCell = cell;
       deleteType = type;
       deleteTimestamp = timestamp;
     }
@@ -106,8 +102,8 @@ public class ScanDeleteTracker implements DeleteTracker {
       return DeleteResult.FAMILY_VERSION_DELETED;
     }
 
-    if (deleteBuffer != null) {
-      int ret = -(CellComparator.compareQualifiers(cell, deleteBuffer, deleteOffset, deleteLength));
+    if (deleteCell != null) {
+      int ret = -(CellComparator.compareQualifiers(cell, deleteCell));
       if (ret == 0) {
         if (deleteType == KeyValue.Type.DeleteColumn.getCode()) {
           return DeleteResult.COLUMN_DELETED;
@@ -121,13 +117,15 @@ public class ScanDeleteTracker implements DeleteTracker {
         assert timestamp < deleteTimestamp;
 
         // different timestamp, let's clear the buffer.
-        deleteBuffer = null;
+        deleteCell = null;
       } else if (ret < 0) {
         // Next column case.
-        deleteBuffer = null;
+        deleteCell = null;
       } else {
         throw new IllegalStateException("isDelete failed: deleteBuffer="
-            + Bytes.toStringBinary(deleteBuffer, deleteOffset, deleteLength) + ", qualifier="
+            + Bytes.toStringBinary(deleteCell.getQualifierArray(),
+                    deleteCell.getQualifierOffset(), deleteCell.getQualifierLength())
+                + ", qualifier="
             + Bytes.toStringBinary(cell.getQualifierArray(), cell.getQualifierOffset(),
               cell.getQualifierLength())
             + ", timestamp=" + timestamp + ", comparison result: " + ret);
@@ -139,7 +137,7 @@ public class ScanDeleteTracker implements DeleteTracker {
 
   @Override
   public boolean isEmpty() {
-    return deleteBuffer == null && !hasFamilyStamp && familyVersionStamps.isEmpty();
+    return deleteCell == null && !hasFamilyStamp && familyVersionStamps.isEmpty();
   }
 
   @Override
@@ -148,7 +146,7 @@ public class ScanDeleteTracker implements DeleteTracker {
     hasFamilyStamp = false;
     familyStamp = 0L;
     familyVersionStamps.clear();
-    deleteBuffer = null;
+    deleteCell = null;
   }
 
   @Override
-- 
2.9.3

