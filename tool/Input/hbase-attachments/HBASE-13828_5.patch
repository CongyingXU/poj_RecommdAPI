From 110a02b5e3aba253bdf938ade016815cb999d456 Mon Sep 17 00:00:00 2001
From: Ashish Singhi <ashish.singhi@huawei.com>
Date: Fri, 5 Jun 2015 11:48:45 +0530
Subject: [PATCH] HBASE-13828 Add group permissions testing coverage to AC.

---
 .../security/access/TestAccessController.java      | 299 +++++++++++++--------
 .../security/access/TestAccessController2.java     | 119 ++++----
 .../security/access/TestNamespaceCommands.java     | 197 +++++---------
 3 files changed, 320 insertions(+), 295 deletions(-)

diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java
index f2d3dff..fa8e3e3 100644
--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java
+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java
@@ -160,6 +160,16 @@ public class TestAccessController extends SecureTestUtil {
   // user with admin rights on the column family
   private static User USER_ADMIN_CF;
 
+  private static final String TESTGROUP_A = "testgroup_a";
+  private static final String TESTGROUP_C = "testgroup_c";
+  private static final String TESTGROUP_R = "testgroup_r";
+  private static final String TESTGROUP_W = "testgroup_w";
+
+  private static User TESTGROUP_A_USER;
+  private static User TESTGROUP_C_USER;
+  private static User TESTGROUP_R_USER;
+  private static User TESTGROUP_W_USER;
+
   // TODO: convert this test to cover the full matrix in
   // https://hbase.apache.org/book/appendix_acl_matrix.html
   // creating all Scope x Permission combinations
@@ -214,6 +224,15 @@ public class TestAccessController extends SecureTestUtil {
     USER_NONE = User.createUserForTesting(conf, "nouser", new String[0]);
     USER_ADMIN_CF = User.createUserForTesting(conf, "col_family_admin", new String[0]);
 
+    TESTGROUP_A_USER =
+        User.createUserForTesting(conf, "testgroup_a_user", new String[] { TESTGROUP_A });
+    TESTGROUP_C_USER =
+        User.createUserForTesting(conf, "testgroup_c_user", new String[] { TESTGROUP_C });
+    TESTGROUP_R_USER =
+        User.createUserForTesting(conf, "testgroup_r_user", new String[] { TESTGROUP_R });
+    TESTGROUP_W_USER =
+        User.createUserForTesting(conf, "testgroup_w_user", new String[] { TESTGROUP_W });
+
     systemUserConnection = TEST_UTIL.getConnection();
     setUpTableAndUserPermissions();
   }
@@ -265,6 +284,11 @@ public class TestAccessController extends SecureTestUtil {
       TEST_TABLE, TEST_FAMILY,
       null, Permission.Action.ADMIN, Permission.Action.CREATE);
 
+    grantGlobal(TEST_UTIL, convertToGroup(TESTGROUP_A), Permission.Action.ADMIN);
+    grantGlobal(TEST_UTIL, convertToGroup(TESTGROUP_C), Permission.Action.CREATE);
+    grantGlobal(TEST_UTIL, convertToGroup(TESTGROUP_R), Permission.Action.READ);
+    grantGlobal(TEST_UTIL, convertToGroup(TESTGROUP_W), Permission.Action.WRITE);
+
     assertEquals(5, AccessControlLists.getTablePermissions(conf, TEST_TABLE).size());
     try {
       assertEquals(5, AccessControlClient.getUserPermissions(systemUserConnection,
@@ -303,10 +327,11 @@ public class TestAccessController extends SecureTestUtil {
     };
 
     // verify that superuser can create tables
-    verifyAllowed(createTable, SUPERUSER, USER_ADMIN);
+    verifyAllowed(createTable, SUPERUSER, USER_ADMIN, TESTGROUP_C_USER);
 
     // all others should be denied
-    verifyDenied(createTable, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+    verifyDenied(createTable, USER_CREATE, USER_RW, USER_RO, USER_NONE, TESTGROUP_A_USER,
+      TESTGROUP_R_USER, TESTGROUP_W_USER);
   }
 
   @Test
@@ -323,8 +348,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(modifyTable, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER);
-    verifyDenied(modifyTable, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(modifyTable, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, TESTGROUP_C_USER,
+      TESTGROUP_A_USER);
+    verifyDenied(modifyTable, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER, TESTGROUP_W_USER);
   }
 
   @Test
@@ -338,8 +364,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(deleteTable, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER);
-    verifyDenied(deleteTable, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(deleteTable, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, TESTGROUP_C_USER,
+      TESTGROUP_A_USER);
+    verifyDenied(deleteTable, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER, TESTGROUP_W_USER);
   }
 
   @Test
@@ -354,8 +381,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(truncateTable, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER);
-    verifyDenied(truncateTable, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(truncateTable, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, TESTGROUP_C_USER,
+      TESTGROUP_A_USER);
+    verifyDenied(truncateTable, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER, TESTGROUP_W_USER);
   }
 
   @Test
@@ -370,8 +398,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER);
-    verifyDenied(action, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, TESTGROUP_C_USER,
+      TESTGROUP_A_USER);
+    verifyDenied(action, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER, TESTGROUP_W_USER);
   }
 
   @Test
@@ -387,8 +416,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, USER_ADMIN_CF);
-    verifyDenied(action, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, USER_ADMIN_CF,
+      TESTGROUP_C_USER, TESTGROUP_A_USER);
+    verifyDenied(action, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER, TESTGROUP_W_USER);
   }
 
   @Test
@@ -402,8 +432,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, USER_ADMIN_CF);
-    verifyDenied(action, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, USER_ADMIN_CF,
+      TESTGROUP_C_USER, TESTGROUP_A_USER);
+    verifyDenied(action, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER, TESTGROUP_W_USER);
   }
 
   @Test
@@ -426,11 +457,13 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(disableTable, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER);
-    verifyDenied(disableTable, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(disableTable, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, TESTGROUP_C_USER,
+      TESTGROUP_A_USER);
+    verifyDenied(disableTable, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER, TESTGROUP_W_USER);
 
     // No user should be allowed to disable _acl_ table
-    verifyDenied(disableAclTable, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, USER_RW, USER_RO);
+    verifyDenied(disableAclTable, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, USER_RW, USER_RO,
+      TESTGROUP_C_USER, TESTGROUP_A_USER, TESTGROUP_R_USER, TESTGROUP_W_USER);
   }
 
   @Test
@@ -444,8 +477,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(enableTable, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER);
-    verifyDenied(enableTable, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(enableTable, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, TESTGROUP_C_USER,
+      TESTGROUP_A_USER);
+    verifyDenied(enableTable, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER, TESTGROUP_W_USER);
   }
 
   @Test
@@ -466,8 +500,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER);
-    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -486,8 +521,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER);
-    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -506,8 +542,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER);
-    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -526,8 +563,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER);
-    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -540,8 +578,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN);
-    verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN,TESTGROUP_A_USER);
+    verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -554,8 +593,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN);
-    verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -568,8 +608,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN);
-    verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -582,13 +623,15 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN);
-    verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   private void verifyWrite(AccessTestAction action) throws Exception {
-    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE, USER_RW);
-    verifyDenied(action, USER_NONE, USER_RO);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE, USER_RW,
+      TESTGROUP_W_USER);
+    verifyDenied(action, USER_NONE, USER_RO, TESTGROUP_A_USER, TESTGROUP_R_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -601,8 +644,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER);
-    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -617,8 +661,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER);
-    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -638,8 +683,9 @@ public class TestAccessController extends SecureTestUtil {
         }
       };
 
-      verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER);
-      verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+      verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+      verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+        TESTGROUP_W_USER, TESTGROUP_C_USER);
     } finally {
       deleteTable(TEST_UTIL, tname);
     }
@@ -655,8 +701,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE);
-    verifyDenied(action, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE, TESTGROUP_C_USER,
+      TESTGROUP_A_USER);
+    verifyDenied(action, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER, TESTGROUP_W_USER);
   }
 
   @Test
@@ -670,18 +717,21 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE);
-    verifyDenied(action, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE, TESTGROUP_C_USER,
+      TESTGROUP_A_USER);
+    verifyDenied(action, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER, TESTGROUP_W_USER);
   }
 
   private void verifyRead(AccessTestAction action) throws Exception {
-    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE, USER_RW, USER_RO);
-    verifyDenied(action, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE, USER_RW, USER_RO,
+      TESTGROUP_R_USER);
+    verifyDenied(action, USER_NONE, TESTGROUP_C_USER, TESTGROUP_A_USER, TESTGROUP_W_USER);
   }
 
   private void verifyReadWrite(AccessTestAction action) throws Exception {
     verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE, USER_RW);
-    verifyDenied(action, USER_NONE, USER_RO);
+    verifyDenied(action, USER_NONE, USER_RO, TESTGROUP_A_USER, TESTGROUP_C_USER, TESTGROUP_R_USER,
+      TESTGROUP_W_USER);
   }
 
   @Test
@@ -837,8 +887,10 @@ public class TestAccessController extends SecureTestUtil {
 
       // User performing bulk loads must have privilege to read table metadata
       // (ADMIN or CREATE)
-      verifyAllowed(bulkLoadAction, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE);
-      verifyDenied(bulkLoadAction, USER_RW, USER_NONE, USER_RO);
+      verifyAllowed(bulkLoadAction, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE,
+        TESTGROUP_C_USER);
+      verifyDenied(bulkLoadAction, USER_RW, USER_NONE, USER_RO, TESTGROUP_R_USER, TESTGROUP_W_USER,
+        TESTGROUP_A_USER);
     } finally {
       // Reinit after the bulk upload
       TEST_UTIL.getHBaseAdmin().disableTable(TEST_TABLE);
@@ -943,8 +995,10 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(appendAction, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE, USER_RW);
-    verifyDenied(appendAction, USER_RO, USER_NONE);
+    verifyAllowed(appendAction, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE, USER_RW,
+      TESTGROUP_W_USER);
+    verifyDenied(appendAction, USER_RO, USER_NONE, TESTGROUP_C_USER, TESTGROUP_R_USER,
+      TESTGROUP_A_USER);
   }
 
   @Test
@@ -1007,18 +1061,21 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(grantAction, SUPERUSER, USER_ADMIN, USER_OWNER);
-    verifyDenied(grantAction, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(grantAction, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+    verifyDenied(grantAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
     try {
-      verifyAllowed(revokeAction, SUPERUSER, USER_ADMIN, USER_OWNER);
-      verifyDenied(revokeAction, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+      verifyAllowed(revokeAction, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+      verifyDenied(revokeAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+        TESTGROUP_W_USER, TESTGROUP_C_USER);
 
-      verifyAllowed(getTablePermissionsAction, SUPERUSER, USER_ADMIN, USER_OWNER);
-      verifyDenied(getTablePermissionsAction, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+      verifyAllowed(getTablePermissionsAction, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+      verifyDenied(getTablePermissionsAction, USER_CREATE, USER_RW, USER_RO, USER_NONE,
+        TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
 
-      verifyAllowed(getGlobalPermissionsAction, SUPERUSER, USER_ADMIN);
+      verifyAllowed(getGlobalPermissionsAction, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
       verifyDenied(getGlobalPermissionsAction, USER_CREATE, USER_OWNER, USER_RW, USER_RO,
-        USER_NONE);
+        USER_NONE, TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
     } finally {
       // Cleanup, Grant the revoked permission back to the user
       grantOnTable(TEST_UTIL, USER_RO.getShortName(), TEST_TABLE, TEST_FAMILY, null,
@@ -1524,8 +1581,8 @@ public class TestAccessController extends SecureTestUtil {
     }
     UserPermission adminPerm = new UserPermission(Bytes.toBytes(USER_ADMIN.getShortName()),
       AccessControlLists.ACL_TABLE_NAME, null, null, Bytes.toBytes("ACRW"));
-    assertTrue("Only user admin has permission on table _acl_ per setup",
-      perms.size() == 1 && hasFoundUserPermission(adminPerm, perms));
+    assertTrue("Only global users and user admin has permission on table _acl_ per setup",
+      perms.size() == 5 && hasFoundUserPermission(adminPerm, perms));
   }
 
   /** global operations */
@@ -1712,8 +1769,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN);
-    verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -1726,8 +1784,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN);
-    verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -1740,8 +1799,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN);
-    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER, TESTGROUP_C_USER,
+      TESTGROUP_R_USER, TESTGROUP_W_USER);
   }
 
   @Test
@@ -1754,8 +1814,9 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(action, SUPERUSER, USER_ADMIN);
-    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(action, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER, TESTGROUP_C_USER,
+      TESTGROUP_R_USER, TESTGROUP_W_USER);
   }
 
   @Test
@@ -1802,17 +1863,21 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(snapshotAction, SUPERUSER, USER_ADMIN, USER_OWNER);
-    verifyDenied(snapshotAction, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(snapshotAction, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+    verifyDenied(snapshotAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
 
-    verifyAllowed(cloneAction, SUPERUSER, USER_ADMIN);
-    verifyDenied(deleteAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER);
+    verifyAllowed(cloneAction, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(deleteAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER,
+      TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
 
-    verifyAllowed(restoreAction, SUPERUSER, USER_ADMIN);
-    verifyDenied(restoreAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER);
+    verifyAllowed(restoreAction, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(restoreAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER,
+      TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
 
-    verifyAllowed(deleteAction, SUPERUSER, USER_ADMIN);
-    verifyDenied(cloneAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER);
+    verifyAllowed(deleteAction, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(cloneAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER,
+      TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -1832,8 +1897,9 @@ public class TestAccessController extends SecureTestUtil {
         return null;
       }
     };
-    verifyAllowed(snapshotAction, SUPERUSER, USER_ADMIN, USER_OWNER);
-    verifyDenied(snapshotAction, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(snapshotAction, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+    verifyDenied(snapshotAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
 
     AccessTestAction deleteAction = new AccessTestAction() {
       @Override
@@ -1843,8 +1909,9 @@ public class TestAccessController extends SecureTestUtil {
         return null;
       }
     };
-    verifyAllowed(deleteAction, SUPERUSER, USER_ADMIN, USER_OWNER);
-    verifyDenied(deleteAction, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(deleteAction, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+    verifyDenied(deleteAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
 
     AccessTestAction restoreAction = new AccessTestAction() {
       @Override
@@ -1854,8 +1921,9 @@ public class TestAccessController extends SecureTestUtil {
         return null;
       }
     };
-    verifyAllowed(restoreAction, SUPERUSER, USER_ADMIN, USER_OWNER);
-    verifyDenied(restoreAction, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(restoreAction, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+    verifyDenied(restoreAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER, TESTGROUP_C_USER);
 
     AccessTestAction cloneAction = new AccessTestAction() {
       @Override
@@ -1867,8 +1935,9 @@ public class TestAccessController extends SecureTestUtil {
     };
     // Clone by snapshot owner is not allowed , because clone operation creates a new table,
     // which needs global admin permission.
-    verifyAllowed(cloneAction, SUPERUSER, USER_ADMIN);
-    verifyDenied(cloneAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER);
+    verifyAllowed(cloneAction, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(cloneAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER,
+      TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -1962,12 +2031,15 @@ public class TestAccessController extends SecureTestUtil {
         }
       };
 
-      verifyAllowed(listTablesAction, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, TABLE_ADMIN);
-      verifyIfEmptyList(listTablesAction, USER_RW, USER_RO, USER_NONE);
+      verifyAllowed(listTablesAction, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, TABLE_ADMIN,
+        TESTGROUP_C_USER, TESTGROUP_A_USER);
+      verifyIfEmptyList(listTablesAction, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+        TESTGROUP_W_USER);
 
       verifyAllowed(getTableDescAction, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER,
-        TABLE_ADMIN);
-      verifyDenied(getTableDescAction, USER_RW, USER_RO, USER_NONE);
+        TABLE_ADMIN, TESTGROUP_C_USER, TESTGROUP_A_USER);
+      verifyDenied(getTableDescAction, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+        TESTGROUP_W_USER);
     } finally {
       // Cleanup, revoke TABLE ADMIN privs
       revokeFromTable(TEST_UTIL, TABLE_ADMIN.getShortName(), TEST_TABLE, null, null,
@@ -1992,8 +2064,8 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(listTablesAction, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER,
-        USER_RW, USER_RO);
+    verifyAllowed(listTablesAction, SUPERUSER, USER_ADMIN, USER_CREATE, USER_OWNER, USER_RW,
+      USER_RO, TESTGROUP_C_USER, TESTGROUP_A_USER, TESTGROUP_R_USER, TESTGROUP_W_USER);
     verifyIfEmptyList(listTablesAction, USER_NONE);
   }
 
@@ -2022,7 +2094,8 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyDenied(deleteTableAction, USER_RW, USER_RO, USER_NONE);
+    verifyDenied(deleteTableAction, USER_RW, USER_RO, USER_NONE, TESTGROUP_R_USER,
+      TESTGROUP_W_USER);
     verifyAllowed(deleteTableAction, TABLE_ADMIN);
   }
 
@@ -2354,21 +2427,24 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(setUserQuotaAction, SUPERUSER, USER_ADMIN);
-    verifyDenied(setUserQuotaAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER);
+    verifyAllowed(setUserQuotaAction, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(setUserQuotaAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER,
+      TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
 
-    verifyAllowed(setUserTableQuotaAction, SUPERUSER, USER_ADMIN, USER_OWNER);
-    verifyDenied(setUserTableQuotaAction, USER_CREATE, USER_RW, USER_RO, USER_NONE);
+    verifyAllowed(setUserTableQuotaAction, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
+    verifyDenied(setUserTableQuotaAction, USER_CREATE, USER_RW, USER_RO, USER_NONE,
+      TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
 
-    verifyAllowed(setUserNamespaceQuotaAction, SUPERUSER, USER_ADMIN);
-    verifyDenied(setUserNamespaceQuotaAction, USER_CREATE, USER_RW, USER_RO, USER_NONE,
-      USER_OWNER);
+    verifyAllowed(setUserNamespaceQuotaAction, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(setUserNamespaceQuotaAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER,
+      TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
 
-    verifyAllowed(setTableQuotaAction, SUPERUSER, USER_ADMIN, USER_OWNER);
+    verifyAllowed(setTableQuotaAction, SUPERUSER, USER_ADMIN, USER_OWNER, TESTGROUP_A_USER);
     verifyDenied(setTableQuotaAction, USER_CREATE, USER_RW, USER_RO, USER_NONE);
 
-    verifyAllowed(setNamespaceQuotaAction, SUPERUSER, USER_ADMIN);
-    verifyDenied(setNamespaceQuotaAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER);
+    verifyAllowed(setNamespaceQuotaAction, SUPERUSER, USER_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(setNamespaceQuotaAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER,
+      TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -2466,7 +2542,7 @@ public class TestAccessController extends SecureTestUtil {
 
     // Verify that we can read sys-tables
     String aclTableName = AccessControlLists.ACL_TABLE_NAME.getNameAsString();
-    assertEquals(1, SUPERUSER.runAs(getPrivilegedAction(aclTableName)).size());
+    assertEquals(5, SUPERUSER.runAs(getPrivilegedAction(aclTableName)).size());
     assertEquals(0, testRegexHandler.runAs(getPrivilegedAction(aclTableName)).size());
 
     // Grant TABLE ADMIN privs to testUserPerms
@@ -2491,8 +2567,10 @@ public class TestAccessController extends SecureTestUtil {
   }
 
   private void verifyAnyCreate(AccessTestAction action) throws Exception {
-    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE, USER_ADMIN_CF);
-    verifyDenied(action, USER_NONE, USER_RO, USER_RW);
+    verifyAllowed(action, SUPERUSER, USER_ADMIN, USER_OWNER, USER_CREATE, USER_ADMIN_CF,
+      TESTGROUP_C_USER);
+    verifyDenied(action, USER_NONE, USER_RO, USER_RW, TESTGROUP_R_USER, TESTGROUP_W_USER,
+      TESTGROUP_A_USER);
   }
 
   @Test
@@ -2530,7 +2608,8 @@ public class TestAccessController extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(replicateLogEntriesAction, SUPERUSER, USER_ADMIN);
-    verifyDenied(replicateLogEntriesAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER);
+    verifyAllowed(replicateLogEntriesAction, SUPERUSER, USER_ADMIN, TESTGROUP_W_USER);
+    verifyDenied(replicateLogEntriesAction, USER_CREATE, USER_RW, USER_RO, USER_NONE, USER_OWNER,
+      TESTGROUP_R_USER, TESTGROUP_A_USER, TESTGROUP_C_USER);
   }
 }
diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController2.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController2.java
index ecb3136..b6aaa56 100644
--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController2.java
+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController2.java
@@ -42,7 +42,6 @@ import org.apache.hadoop.hbase.client.Result;
 import org.apache.hadoop.hbase.client.ResultScanner;
 import org.apache.hadoop.hbase.client.Scan;
 import org.apache.hadoop.hbase.client.Table;
-import org.apache.hadoop.hbase.master.HMaster;
 import org.apache.hadoop.hbase.security.User;
 import org.apache.hadoop.hbase.security.access.Permission.Action;
 import org.apache.hadoop.hbase.testclassification.LargeTests;
@@ -201,22 +200,26 @@ public class TestAccessController2 extends SecureTestUtil {
   @Test
   public void testCreateTableWithGroupPermissions() throws Exception {
     grantGlobal(TEST_UTIL, convertToGroup(TESTGROUP_1), Action.CREATE);
-    AccessTestAction createAction = new AccessTestAction() {
-      @Override
-      public Object run() throws Exception {
-        HTableDescriptor desc = new HTableDescriptor(TEST_TABLE.getTableName());
-        desc.addFamily(new HColumnDescriptor(TEST_FAMILY));
-        try (Connection connection = ConnectionFactory.createConnection(TEST_UTIL.getConfiguration())) {
-          try (Admin admin = connection.getAdmin()) {
-            admin.createTable(desc);
+    try {
+      AccessTestAction createAction = new AccessTestAction() {
+        @Override
+        public Object run() throws Exception {
+          HTableDescriptor desc = new HTableDescriptor(TEST_TABLE.getTableName());
+          desc.addFamily(new HColumnDescriptor(TEST_FAMILY));
+          try (Connection connection =
+              ConnectionFactory.createConnection(TEST_UTIL.getConfiguration())) {
+            try (Admin admin = connection.getAdmin()) {
+              admin.createTable(desc);
+            }
           }
+          return null;
         }
-        return null;
-      }
-    };
-    verifyAllowed(createAction, TESTGROUP1_USER1);
-    verifyDenied(createAction, TESTGROUP2_USER1);
-    revokeGlobal(TEST_UTIL, convertToGroup(TESTGROUP_1), Action.CREATE);
+      };
+      verifyAllowed(createAction, TESTGROUP1_USER1);
+      verifyDenied(createAction, TESTGROUP2_USER1);
+    } finally {
+      revokeGlobal(TEST_UTIL, convertToGroup(TESTGROUP_1), Action.CREATE);
+    }
   }
 
   @Test
@@ -264,55 +267,65 @@ public class TestAccessController2 extends SecureTestUtil {
     SecureTestUtil.grantOnTable(TEST_UTIL, tableAdmin.getShortName(),
       TEST_TABLE.getTableName(), null, null, Action.ADMIN);
 
-    // Write tests
+    grantGlobal(TEST_UTIL, convertToGroup(TESTGROUP_1), Action.WRITE);
+    try {
+      // Write tests
 
-    AccessTestAction writeAction = new AccessTestAction() {
-      @Override
-      public Object run() throws Exception {
+      AccessTestAction writeAction = new AccessTestAction() {
+        @Override
+        public Object run() throws Exception {
 
-        try(Connection conn = ConnectionFactory.createConnection(conf);
-            Table t = conn.getTable(AccessControlLists.ACL_TABLE_NAME)) {
-          t.put(new Put(TEST_ROW).add(AccessControlLists.ACL_LIST_FAMILY, TEST_QUALIFIER,
-            TEST_VALUE));
-          return null;
-        } finally {
+          try (Connection conn = ConnectionFactory.createConnection(conf);
+              Table t = conn.getTable(AccessControlLists.ACL_TABLE_NAME)) {
+            t.put(new Put(TEST_ROW).add(AccessControlLists.ACL_LIST_FAMILY, TEST_QUALIFIER,
+              TEST_VALUE));
+            return null;
+          } finally {
+          }
         }
-      }
-    };
-
-    // All writes to ACL table denied except for GLOBAL WRITE permission and superuser
+      };
 
-    verifyDenied(writeAction, globalAdmin, globalCreate, globalRead);
-    verifyDenied(writeAction, nsAdmin, nsCreate, nsRead, nsWrite);
-    verifyDenied(writeAction, tableAdmin, tableCreate, tableRead, tableWrite);
-    verifyAllowed(writeAction, superUser, globalWrite);
+      // All writes to ACL table denied except for GLOBAL WRITE permission and superuser
 
-    // Read tests
+      verifyDenied(writeAction, globalAdmin, globalCreate, globalRead, TESTGROUP2_USER1);
+      verifyDenied(writeAction, nsAdmin, nsCreate, nsRead, nsWrite);
+      verifyDenied(writeAction, tableAdmin, tableCreate, tableRead, tableWrite);
+      verifyAllowed(writeAction, superUser, globalWrite, TESTGROUP1_USER1);
+    } finally {
+      revokeGlobal(TEST_UTIL, convertToGroup(TESTGROUP_1), Action.WRITE);
+    }
 
-    AccessTestAction scanAction = new AccessTestAction() {
-      @Override
-      public Object run() throws Exception {
-        try(Connection conn = ConnectionFactory.createConnection(conf);
-            Table t = conn.getTable(AccessControlLists.ACL_TABLE_NAME)) {
-          ResultScanner s = t.getScanner(new Scan());
-          try {
-            for (Result r = s.next(); r != null; r = s.next()) {
-              // do nothing
+    grantGlobal(TEST_UTIL, convertToGroup(TESTGROUP_1), Action.READ);
+    try {
+      // Read tests
+
+      AccessTestAction scanAction = new AccessTestAction() {
+        @Override
+        public Object run() throws Exception {
+          try (Connection conn = ConnectionFactory.createConnection(conf);
+              Table t = conn.getTable(AccessControlLists.ACL_TABLE_NAME)) {
+            ResultScanner s = t.getScanner(new Scan());
+            try {
+              for (Result r = s.next(); r != null; r = s.next()) {
+                // do nothing
+              }
+            } finally {
+              s.close();
             }
-          } finally {
-            s.close();
+            return null;
           }
-          return null;
         }
-      }
-    };
+      };
 
-    // All reads from ACL table denied except for GLOBAL READ and superuser
+      // All reads from ACL table denied except for GLOBAL READ and superuser
 
-    verifyDenied(scanAction, globalAdmin, globalCreate, globalWrite);
-    verifyDenied(scanAction, nsCreate, nsAdmin, nsRead, nsWrite);
-    verifyDenied(scanAction, tableCreate, tableAdmin, tableRead, tableWrite);
-    verifyAllowed(scanAction, superUser, globalRead);
+      verifyDenied(scanAction, globalAdmin, globalCreate, globalWrite, TESTGROUP2_USER1);
+      verifyDenied(scanAction, nsCreate, nsAdmin, nsRead, nsWrite);
+      verifyDenied(scanAction, tableCreate, tableAdmin, tableRead, tableWrite);
+      verifyAllowed(scanAction, superUser, globalRead, TESTGROUP1_USER1);
+    } finally {
+      revokeGlobal(TEST_UTIL, convertToGroup(TESTGROUP_1), Action.READ);
+    }
   }
 
   /*
diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestNamespaceCommands.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestNamespaceCommands.java
index 457bb3b..c88c312 100644
--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestNamespaceCommands.java
+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestNamespaceCommands.java
@@ -92,6 +92,16 @@ public class TestNamespaceCommands extends SecureTestUtil {
   //user with create table permissions alone
   private static User USER_TABLE_CREATE; // TODO: WE DO NOT GIVE ANY PERMS TO THIS USER
 
+  private static final String TESTGROUP_A = "testgroup_a";
+  private static final String TESTGROUP_C = "testgroup_c";
+  private static final String TESTGROUP_R = "testgroup_r";
+  private static final String TESTGROUP_W = "testgroup_w";
+
+  private static User TESTGROUP_A_USER;
+  private static User TESTGROUP_C_USER;
+  private static User TESTGROUP_R_USER;
+  private static User TESTGROUP_W_USER;
+
   private static String TEST_TABLE = TEST_NAMESPACE + ":testtable";
   private static byte[] TEST_FAMILY = Bytes.toBytes("f1");
 
@@ -116,6 +126,15 @@ public class TestNamespaceCommands extends SecureTestUtil {
 
     USER_TABLE_CREATE = User.createUserForTesting(conf, "table_create", new String[0]);
     USER_TABLE_WRITE = User.createUserForTesting(conf, "table_write", new String[0]);
+
+    TESTGROUP_A_USER =
+        User.createUserForTesting(conf, "testgroup_a_user", new String[] { TESTGROUP_A });
+    TESTGROUP_C_USER =
+        User.createUserForTesting(conf, "testgroup_c_user", new String[] { TESTGROUP_C });
+    TESTGROUP_R_USER =
+        User.createUserForTesting(conf, "testgroup_r_user", new String[] { TESTGROUP_R });
+    TESTGROUP_W_USER =
+        User.createUserForTesting(conf, "testgroup_w_user", new String[] { TESTGROUP_W });
     // TODO: other table perms
 
     UTIL.startMiniCluster();
@@ -144,6 +163,11 @@ public class TestNamespaceCommands extends SecureTestUtil {
     grantOnNamespace(UTIL, USER_NS_EXEC.getShortName(),   TEST_NAMESPACE, Permission.Action.EXEC);
 
     grantOnNamespace(UTIL, USER_NS_ADMIN.getShortName(), TEST_NAMESPACE2, Permission.Action.ADMIN);
+
+    grantGlobal(UTIL, convertToGroup(TESTGROUP_A), Permission.Action.ADMIN);
+    grantGlobal(UTIL, convertToGroup(TESTGROUP_C), Permission.Action.CREATE);
+    grantGlobal(UTIL, convertToGroup(TESTGROUP_R), Permission.Action.READ);
+    grantGlobal(UTIL, convertToGroup(TESTGROUP_W), Permission.Action.WRITE);
   }
 
   @AfterClass
@@ -204,20 +228,10 @@ public class TestNamespaceCommands extends SecureTestUtil {
     };
 
     // modifyNamespace: superuser | global(A) | NS(A)
-    verifyAllowed(modifyNamespace,
-      SUPERUSER,
-      USER_GLOBAL_ADMIN);
-
-    verifyDenied(modifyNamespace,
-        USER_GLOBAL_CREATE,
-        USER_GLOBAL_WRITE,
-        USER_GLOBAL_READ,
-        USER_GLOBAL_EXEC,
-        USER_NS_ADMIN,
-        USER_NS_CREATE,
-        USER_NS_WRITE,
-        USER_NS_READ,
-        USER_NS_EXEC);
+    verifyAllowed(modifyNamespace, SUPERUSER, USER_GLOBAL_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(modifyNamespace, USER_GLOBAL_CREATE, USER_GLOBAL_WRITE, USER_GLOBAL_READ,
+      USER_GLOBAL_EXEC, USER_NS_ADMIN, USER_NS_CREATE, USER_NS_WRITE, USER_NS_READ, USER_NS_EXEC,
+      TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -241,41 +255,17 @@ public class TestNamespaceCommands extends SecureTestUtil {
     };
 
     // createNamespace: superuser | global(A)
-    verifyAllowed(createNamespace,
-      SUPERUSER,
-      USER_GLOBAL_ADMIN);
-
+    verifyAllowed(createNamespace, SUPERUSER, USER_GLOBAL_ADMIN, TESTGROUP_A_USER);
     // all others should be denied
-    verifyDenied(createNamespace,
-        USER_GLOBAL_CREATE,
-        USER_GLOBAL_WRITE,
-        USER_GLOBAL_READ,
-        USER_GLOBAL_EXEC,
-        USER_NS_ADMIN,
-        USER_NS_CREATE,
-        USER_NS_WRITE,
-        USER_NS_READ,
-        USER_NS_EXEC,
-        USER_TABLE_CREATE,
-        USER_TABLE_WRITE);
+    verifyDenied(createNamespace, USER_GLOBAL_CREATE, USER_GLOBAL_WRITE, USER_GLOBAL_READ,
+      USER_GLOBAL_EXEC, USER_NS_ADMIN, USER_NS_CREATE, USER_NS_WRITE, USER_NS_READ, USER_NS_EXEC,
+      USER_TABLE_CREATE, USER_TABLE_WRITE, TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
 
     // deleteNamespace: superuser | global(A) | NS(A)
-    verifyAllowed(deleteNamespace,
-      SUPERUSER,
-      USER_GLOBAL_ADMIN);
-
-    verifyDenied(deleteNamespace,
-        USER_GLOBAL_CREATE,
-        USER_GLOBAL_WRITE,
-        USER_GLOBAL_READ,
-        USER_GLOBAL_EXEC,
-        USER_NS_ADMIN,
-        USER_NS_CREATE,
-        USER_NS_WRITE,
-        USER_NS_READ,
-        USER_NS_EXEC,
-        USER_TABLE_CREATE,
-        USER_TABLE_WRITE);
+    verifyAllowed(deleteNamespace, SUPERUSER, USER_GLOBAL_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(deleteNamespace, USER_GLOBAL_CREATE, USER_GLOBAL_WRITE, USER_GLOBAL_READ,
+      USER_GLOBAL_EXEC, USER_NS_ADMIN, USER_NS_CREATE, USER_NS_WRITE, USER_NS_READ, USER_NS_EXEC,
+      USER_TABLE_CREATE, USER_TABLE_WRITE, TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -289,22 +279,11 @@ public class TestNamespaceCommands extends SecureTestUtil {
       }
     };
     // getNamespaceDescriptor : superuser | global(A) | NS(A)
-    verifyAllowed(getNamespaceAction,
-      SUPERUSER,
-      USER_GLOBAL_ADMIN,
-      USER_NS_ADMIN);
-
-    verifyDenied(getNamespaceAction,
-        USER_GLOBAL_CREATE,
-        USER_GLOBAL_WRITE,
-        USER_GLOBAL_READ,
-        USER_GLOBAL_EXEC,
-        USER_NS_CREATE,
-        USER_NS_WRITE,
-        USER_NS_READ,
-        USER_NS_EXEC,
-        USER_TABLE_CREATE,
-        USER_TABLE_WRITE);
+    verifyAllowed(getNamespaceAction, SUPERUSER, USER_GLOBAL_ADMIN, USER_NS_ADMIN,
+      TESTGROUP_A_USER);
+    verifyDenied(getNamespaceAction, USER_GLOBAL_CREATE, USER_GLOBAL_WRITE, USER_GLOBAL_READ,
+      USER_GLOBAL_EXEC, USER_NS_CREATE, USER_NS_WRITE, USER_NS_READ, USER_NS_EXEC,
+      USER_TABLE_CREATE, USER_TABLE_WRITE, TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -327,14 +306,12 @@ public class TestNamespaceCommands extends SecureTestUtil {
     // listNamespaces         : All access*
     // * Returned list will only show what you can call getNamespaceDescriptor()
 
-    verifyAllowed(listAction,
-      SUPERUSER,
-      USER_GLOBAL_ADMIN,
-      USER_NS_ADMIN);
+    verifyAllowed(listAction, SUPERUSER, USER_GLOBAL_ADMIN, USER_NS_ADMIN, TESTGROUP_A_USER);
 
     // we have 3 namespaces: [default, hbase, TEST_NAMESPACE, TEST_NAMESPACE2]
     assertEquals(4, ((List)SUPERUSER.runAs(listAction)).size());
     assertEquals(4, ((List)USER_GLOBAL_ADMIN.runAs(listAction)).size());
+    assertEquals(4, ((List)TESTGROUP_A_USER.runAs(listAction)).size());
 
     assertEquals(2, ((List)USER_NS_ADMIN.runAs(listAction)).size());
 
@@ -348,6 +325,9 @@ public class TestNamespaceCommands extends SecureTestUtil {
     assertEquals(0, ((List)USER_NS_EXEC.runAs(listAction)).size());
     assertEquals(0, ((List)USER_TABLE_CREATE.runAs(listAction)).size());
     assertEquals(0, ((List)USER_TABLE_WRITE.runAs(listAction)).size());
+    assertEquals(0, ((List)TESTGROUP_C_USER.runAs(listAction)).size());
+    assertEquals(0, ((List)TESTGROUP_R_USER.runAs(listAction)).size());
+    assertEquals(0, ((List)TESTGROUP_W_USER.runAs(listAction)).size());
   }
 
   @Test
@@ -411,56 +391,21 @@ public class TestNamespaceCommands extends SecureTestUtil {
       }
     };
 
-    verifyAllowed(grantAction,
-      SUPERUSER,
-      USER_GLOBAL_ADMIN);
-
-    verifyDenied(grantAction,
-        USER_GLOBAL_CREATE,
-        USER_GLOBAL_WRITE,
-        USER_GLOBAL_READ,
-        USER_GLOBAL_EXEC,
-        USER_NS_ADMIN,
-        USER_NS_CREATE,
-        USER_NS_WRITE,
-        USER_NS_READ,
-        USER_NS_EXEC,
-        USER_TABLE_CREATE,
-        USER_TABLE_WRITE);
-
-    verifyAllowed(revokeAction,
-      SUPERUSER,
-      USER_GLOBAL_ADMIN);
-
-    verifyDenied(revokeAction,
-        USER_GLOBAL_CREATE,
-        USER_GLOBAL_WRITE,
-        USER_GLOBAL_READ,
-        USER_GLOBAL_EXEC,
-        USER_NS_ADMIN,
-        USER_NS_CREATE,
-        USER_NS_WRITE,
-        USER_NS_READ,
-        USER_NS_EXEC,
-        USER_TABLE_CREATE,
-        USER_TABLE_WRITE);
-
-    verifyAllowed(getPermissionsAction,
-      SUPERUSER,
-      USER_GLOBAL_ADMIN,
-      USER_NS_ADMIN);
-
-    verifyDenied(getPermissionsAction,
-        USER_GLOBAL_CREATE,
-        USER_GLOBAL_WRITE,
-        USER_GLOBAL_READ,
-        USER_GLOBAL_EXEC,
-        USER_NS_CREATE,
-        USER_NS_WRITE,
-        USER_NS_READ,
-        USER_NS_EXEC,
-        USER_TABLE_CREATE,
-        USER_TABLE_WRITE);
+    verifyAllowed(grantAction, SUPERUSER, USER_GLOBAL_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(grantAction, USER_GLOBAL_CREATE, USER_GLOBAL_WRITE, USER_GLOBAL_READ,
+      USER_GLOBAL_EXEC, USER_NS_ADMIN, USER_NS_CREATE, USER_NS_WRITE, USER_NS_READ, USER_NS_EXEC,
+      USER_TABLE_CREATE, USER_TABLE_WRITE, TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
+
+    verifyAllowed(revokeAction, SUPERUSER, USER_GLOBAL_ADMIN, TESTGROUP_A_USER);
+    verifyDenied(revokeAction, USER_GLOBAL_CREATE, USER_GLOBAL_WRITE, USER_GLOBAL_READ,
+      USER_GLOBAL_EXEC, USER_NS_ADMIN, USER_NS_CREATE, USER_NS_WRITE, USER_NS_READ, USER_NS_EXEC,
+      USER_TABLE_CREATE, USER_TABLE_WRITE, TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
+
+    verifyAllowed(getPermissionsAction, SUPERUSER, USER_GLOBAL_ADMIN, USER_NS_ADMIN,
+      TESTGROUP_A_USER);
+    verifyDenied(getPermissionsAction, USER_GLOBAL_CREATE, USER_GLOBAL_WRITE, USER_GLOBAL_READ,
+      USER_GLOBAL_EXEC, USER_NS_CREATE, USER_NS_WRITE, USER_NS_READ, USER_NS_EXEC,
+      USER_TABLE_CREATE, USER_TABLE_WRITE, TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_C_USER);
   }
 
   @Test
@@ -476,21 +421,9 @@ public class TestNamespaceCommands extends SecureTestUtil {
     };
 
     //createTable            : superuser | global(C) | NS(C)
-    verifyAllowed(createTable,
-      SUPERUSER,
-      USER_GLOBAL_CREATE,
-      USER_NS_CREATE);
-
-    verifyDenied(createTable,
-        USER_GLOBAL_ADMIN,
-        USER_GLOBAL_WRITE,
-        USER_GLOBAL_READ,
-        USER_GLOBAL_EXEC,
-        USER_NS_ADMIN,
-        USER_NS_WRITE,
-        USER_NS_READ,
-        USER_NS_EXEC,
-        USER_TABLE_CREATE,
-        USER_TABLE_WRITE);
+    verifyAllowed(createTable, SUPERUSER, USER_GLOBAL_CREATE, USER_NS_CREATE, TESTGROUP_C_USER);
+    verifyDenied(createTable, USER_GLOBAL_ADMIN, USER_GLOBAL_WRITE, USER_GLOBAL_READ,
+      USER_GLOBAL_EXEC, USER_NS_ADMIN, USER_NS_WRITE, USER_NS_READ, USER_NS_EXEC,
+      USER_TABLE_CREATE, USER_TABLE_WRITE, TESTGROUP_R_USER, TESTGROUP_W_USER, TESTGROUP_A_USER);
   }
 }
-- 
1.9.2.msysgit.0

