#!/bin/bash

# Create a NS, set a quota on it, and observe it
echo 'create_namespace "joshns"' | hbase shell
echo 'set_quota TYPE=>SPACE, NAMESPACE=>"joshns", LIMIT=>"2G", POLICY=>NO_WRITES' | hbase shell
echo 'list_quotas' | hbase shell

TABLE1="joshns:quota1"
TABLE2="joshns:quota2"
TABLE3="joshns:quota3"

# Write a small amount of data
hbase ltt -tn "$TABLE1" -write 10:100:30 -num_keys 500 || echo '*** Failed to write data!'

# Make sure the data we wrote is flushed to hfiles
echo "flush '$TABLE1'" | hbase shell

# Ask the master for the size of the table, waiting a little bit for them to be sent
sleep 15
for x in 1 2 3; do echo list_quota_table_sizes | hbase shell; sleep 5; done

# ~1GB for table1
hbase ltt -tn "$TABLE1" -write 10:100:30 -num_keys 525000 || echo '*** Failed to write data!'

# Make sure the data we wrote is flushed to hfiles
echo "flush '$TABLE1'" | hbase shell

# Ask the master for the size of the table, waiting a little bit for them to be sent
sleep 15
for x in 1 2 3; do echo list_quota_table_sizes | hbase shell; sleep 5; done

# Just like we got the size report from the master, we should also be able to get it from the RS
# The RS is pulling this info from the Master
echo "list_quota_snapshots '$(hostname -f),16201'" | hbase shell

# We are still within our quota, so we expect no output
echo "list_quota_violations '$(hostname -f),16201'" | hbase shell

# ~1GB for table2
hbase ltt -tn "$TABLE2" -write 10:100:30 -num_keys 525000 || echo '*** Failed to write data!'
echo "flush '$TABLE2'" | hbase shell

# Ask the master for the size of the table, waiting a little bit for them to be sent
sleep 15
for x in 1 2 3; do echo list_quota_table_sizes | hbase shell; sleep 5; done

# At this point, we're very close to the quota limit. Write a little more data to exceed it
hbase ltt -tn "$TABLE3" -write 10:100:30 -num_keys 100000

echo "flush '$TABLE3'" | hbase shell

sleep 15
for x in 1 2 3; do echo list_quota_table_sizes | hbase shell; sleep 5; done

# We should see violations now!
echo "list_quota_violations '$(hostname -f),16201'" | hbase shell

# We expect all of these to get rejected because the entire NS should be over quota
echo "put '$TABLE1', 'r1', 'test_cf:q1', 'this should be rejected'" | hbase shell

echo "put '$TABLE2', 'r1', 'test_cf:q1', 'this should be rejected'" | hbase shell

echo "put '$TABLE3', 'r1', 'test_cf:q1', 'this should be rejected'" | hbase shell
