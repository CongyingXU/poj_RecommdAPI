From d354d08331c9ecd5f7ca7de2fd4fb83b6ee0f4cc Mon Sep 17 00:00:00 2001
From: Chia-Ping Tsai <chia7712@gmail.com>
Date: Sat, 1 Apr 2017 01:46:06 +0800
Subject: [PATCH] HBASE-17836 CellUtil#estimatedSerializedSizeOf is slow when
 input is ByteBufferCell

---
 hbase-common/src/main/java/org/apache/hadoop/hbase/CellUtil.java | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/hbase-common/src/main/java/org/apache/hadoop/hbase/CellUtil.java b/hbase-common/src/main/java/org/apache/hadoop/hbase/CellUtil.java
index bb5197f..9e8e986 100644
--- a/hbase-common/src/main/java/org/apache/hadoop/hbase/CellUtil.java
+++ b/hbase-common/src/main/java/org/apache/hadoop/hbase/CellUtil.java
@@ -1391,8 +1391,11 @@ public final class CellUtil {
     if (cell instanceof KeyValue) {
       return ((KeyValue)cell).getLength() + Bytes.SIZEOF_INT;
     }
-    // TODO: Should we add to Cell a sizeOf?  Would it help? Does it make sense if Cell is
-    // prefix encoded or compressed?
+
+    if (cell instanceof ExtendedCell) {
+      return ((ExtendedCell)cell).getSerializedSize(true);
+    }
+
     return getSumOfCellElementLengths(cell) +
       // Use the KeyValue's infrastructure size presuming that another implementation would have
       // same basic cost.
-- 
2.9.3

