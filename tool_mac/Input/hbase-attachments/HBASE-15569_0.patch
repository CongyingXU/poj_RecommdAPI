From 86053a95b2ae3172358f55f49a62d3844f4c510d Mon Sep 17 00:00:00 2001
From: Junegunn Choi <junegunn.c@gmail.com>
Date: Thu, 31 Mar 2016 13:20:26 +0900
Subject: [PATCH] HBASE-15569 Make Bytes.toStringBinary faster

---
 .../src/main/java/org/apache/hadoop/hbase/util/Bytes.java   | 13 ++++++++-----
 1 file changed, 8 insertions(+), 5 deletions(-)

diff --git a/hbase-common/src/main/java/org/apache/hadoop/hbase/util/Bytes.java b/hbase-common/src/main/java/org/apache/hadoop/hbase/util/Bytes.java
index aae6c4c..7b9eb0b 100644
--- a/hbase-common/src/main/java/org/apache/hadoop/hbase/util/Bytes.java
+++ b/hbase-common/src/main/java/org/apache/hadoop/hbase/util/Bytes.java
@@ -626,6 +626,10 @@ public class Bytes implements Comparable<Bytes> {
     return toStringBinary(toBytes(buf));
   }
 
+  private static final char[] HEX_CHARS_UPPER = {
+    '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'
+  };
+
   /**
    * Write a printable representation of a byte array. Non-printable
    * characters are hex escaped in the format \\x%02X, eg:
@@ -643,13 +647,12 @@ public class Bytes implements Comparable<Bytes> {
     if (off + len > b.length) len = b.length - off;
     for (int i = off; i < off + len ; ++i) {
       int ch = b[i] & 0xFF;
-      if ((ch >= '0' && ch <= '9')
-          || (ch >= 'A' && ch <= 'Z')
-          || (ch >= 'a' && ch <= 'z')
-          || " `~!@#$%^&*()-_=+[]{}|;:'\",.<>/?".indexOf(ch) >= 0) {
+      if (ch >= ' ' && ch <= '~' && ch != '\\') {
         result.append((char)ch);
       } else {
-        result.append(String.format("\\x%02X", ch));
+        result.append("\\x");
+        result.append(HEX_CHARS_UPPER[ch / 0x10]);
+        result.append(HEX_CHARS_UPPER[ch % 0x10]);
       }
     }
     return result.toString();
-- 
2.6.3

