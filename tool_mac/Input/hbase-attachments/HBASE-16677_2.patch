From b9b7d94ce952313fadaf2934256d511bba57a383 Mon Sep 17 00:00:00 2001
From: Yang Guang <yguang11@yahoo.com>
Date: Wed, 21 Sep 2016 17:33:30 -0700
Subject: [PATCH] Add table size (total store file size) to table page.

---
 .../main/resources/hbase-webapps/master/table.jsp  | 59 +++++++++++++++++++++-
 1 file changed, 58 insertions(+), 1 deletion(-)

diff --git a/hbase-server/src/main/resources/hbase-webapps/master/table.jsp b/hbase-server/src/main/resources/hbase-webapps/master/table.jsp
index 27388e7..75b58ff 100644
--- a/hbase-server/src/main/resources/hbase-webapps/master/table.jsp
+++ b/hbase-server/src/main/resources/hbase-webapps/master/table.jsp
@@ -73,6 +73,26 @@
   }
   String action = request.getParameter("action");
   String key = request.getParameter("key");
+  long totalStoreFileSizeMB = 0;
+  String[] sizeUnits = new String[] {"MB", "GB", "TB", "PB"};
+
+  final String numRegionsParam = request.getParameter("numRegions");
+  // By default, the page render up to 10000 regions to improve the page load time
+  int numRegionsToRender = 10000;
+  if (numRegionsParam != null) {
+    // either 'all' or a number
+    if (numRegionsParam.equals("all")) {
+      numRegionsToRender = -1;
+    } else {
+      try {
+        numRegionsToRender = Integer.parseInt(numRegionsParam);
+      } catch (NumberFormatException ex) {
+        // ignore
+      }
+    }
+  }
+  int numRegions = 0;
+
 %>
 <!--[if IE]>
 <!DOCTYPE html>
@@ -342,6 +362,7 @@ if ( fqtn != null ) {
           totalSize += regionload.getStorefileSizeMB();
           totalStoreFileCount += regionload.getStorefiles();
           totalMemSize += regionload.getMemStoreSizeMB();
+          totalStoreFileSizeMB += regionload.getStorefileSizeMB();
         } else {
           RegionLoad load0 = new RegionLoad(ClusterStatusProtos.RegionLoad.newBuilder().setRegionSpecifier(HBaseProtos.RegionSpecifier.newBuilder().setValue(ByteString.copyFrom(regionInfo.getRegionName())).build()).build());
           regionsToLoad.put(regionInfo, load0);
@@ -547,7 +568,12 @@ ShowDetailName&Start/End Key<input type="checkbox" id="showWhole" style="margin-
           });
     }
   }
-
+  numRegions = regions.size();
+  int numRegionsRendered = 0;
+  // render all regions
+  if (numRegionsToRender < 0) {
+    numRegionsToRender = numRegions;
+  }
   for (Map.Entry<HRegionInfo, RegionLoad> hriEntry : entryList) {
     HRegionInfo regionInfo = hriEntry.getKey();
     ServerName addr = regionsToServer.get(regionInfo);
@@ -583,6 +609,8 @@ ShowDetailName&Start/End Key<input type="checkbox" id="showWhole" style="margin-
         }
       }
     }
+    if (numRegionsRendered < numRegionsToRender) {
+      numRegionsRendered++;
 %>
 <tr>
   <td><%= escapeXml(showWhole?Bytes.toStringBinary(regionInfo.getRegionName()):regionInfo.getEncodedName()) %></td>
@@ -616,7 +644,15 @@ ShowDetailName&Start/End Key<input type="checkbox" id="showWhole" style="margin-
   %>
 </tr>
 <% } %>
++<% } %>
 </table>
+<% if (numRegions > numRegionsRendered) {
+     String allRegionsUrl = "?name=" + fqtn + "&numRegions=all";
+%>
+  <p>This table has <b><%= numRegions %></b> regions in total, in order to improve the page load time,
+     only <b><%= numRegionsRendered %></b> regions are displayed here, <a href="<%= allRegionsUrl %>">click
+     here</a> to see all regions.</p>
+<% } %>
 <h2>Regions by Region Server</h2>
 <%
 if (withReplica) {
@@ -656,6 +692,27 @@ if (withReplica) {
 } // end else
 %>
 
+<h2>Table Stats</h2>
+<table class="table table-striped">
+  <tr>
+    <th>Name</th>
+    <th>Value</th>
+    <th>Description</th>
+  </tr>
+  <tr>
+    <td>Size</td>
+    <%
+      int i = 0;
+      double storeSize = totalStoreFileSizeMB;
+      while (storeSize > 1024 && i < sizeUnits.length - 1)  {
+        storeSize /= 1024;
+        ++i;
+      }
+    %>
+    <td><%= String.format("%.2f", storeSize)%> <%= sizeUnits[i]%></td>
+    <td>Total size of store files (in bytes)</td>
+  </tr>
+</table>
 
 <% if (!readOnly) { %>
 <p><hr/></p>
-- 
2.3.8 (Apple Git-58)

