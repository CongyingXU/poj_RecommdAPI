From fa251e9c233b2440d656a7e12b3db0f9b8da13c2 Mon Sep 17 00:00:00 2001
From: Tom Tsuruhara <tomu.tsuruhara@linecorp.com>
Date: Fri, 9 Sep 2016 17:24:03 +0900
Subject: [PATCH] HBONE-92 Prevent threadlocalmap growing

---
 hbase-common/src/main/java/org/apache/hadoop/hbase/util/Counter.java  | 4 ++++
 hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java | 1 +
 2 files changed, 5 insertions(+)

diff --git a/hbase-common/src/main/java/org/apache/hadoop/hbase/util/Counter.java b/hbase-common/src/main/java/org/apache/hadoop/hbase/util/Counter.java
index 7b8a7e9..92c0a8f 100644
--- a/hbase-common/src/main/java/org/apache/hadoop/hbase/util/Counter.java
+++ b/hbase-common/src/main/java/org/apache/hadoop/hbase/util/Counter.java
@@ -181,6 +181,10 @@ public class Counter {
     return sum;
   }
 
+  public void destroy() {
+    indexHolderThreadLocal.remove();
+  }
+
   @Override
   public String toString() {
     Cell[] cells = containerRef.get().cells;
diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java
index 0df5097..a678237 100644
--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java
+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java
@@ -1957,6 +1957,7 @@ public class RpcServer implements RpcServerInterface, ConfigurationObserver {
           LOG.trace("Ignored exception", ignored);
         }
       }
+      rpcCount.destroy();
     }
 
     private UserGroupInformation createUser(ConnectionHeader head) {
-- 
2.7.4 (Apple Git-66)
